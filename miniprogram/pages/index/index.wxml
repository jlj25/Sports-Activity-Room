<!--index.wxml-->

<!-- 在顶部添加搜索框 -->
<view class="search-bar" wx:if="{{currentView === 'list'}}">
  <input class="search-input" type="text" placeholder="搜索活动场馆" bindinput="onSearchInput" />
  <button class="search-btn" bindtap="onSearch">搜索</button>
</view>

<!-- 顶部分类标签 -->
<scroll-view class="category-tabs" scroll-x wx:if="{{currentView === 'list'}}">
  <view class="tab {{activeCategory == index ? 'active' : ''}}" wx:for="{{categories}}" wx:key="index" data-idx="{{index}}" bindtap="onCategoryTap">{{item}}</view>
</scroll-view>

<!-- 修改筛选栏 -->
<view class="filter-bar" wx:if="{{currentView === 'list'}}">
  <view class="filter-item" bindtap="openPriceFilter">价格筛选 ▼</view>
  <view class="filter-item" bindtap="openRatingFilter">评分筛选 ▼</view>
</view>

<!-- 瀑布流布局的活动列表 -->
<view class="masonry-container" wx:if="{{currentView === 'list'}}">
  <view class="masonry-column">
    <block wx:for="{{leftColumnVenues}}" wx:key="id">
      <view class="venue-card" bindtap="showVenueDetail" data-id="{{item.id}}">
        <image src="{{item.cover}}" class="venue-img" mode="aspectFill" />
        <view class="venue-info">
          <text class="venue-title">{{item.name}}</text>
          <view class="venue-rating">
            <text class="star">★★★★★</text>
            <text class="score">{{item.rating}}</text>
          </view>
          <text class="venue-location">{{item.location}}</text>
          <view class="venue-tags">
            <text wx:for="{{item.sports}}" wx:key="index" class="tag">{{item}}</text>
          </view>
          <view class="venue-price">
            <text class="price">￥{{item.price}}</text>
            <text class="unit">/小时起</text>
          </view>
          <view class="button-group">
            <button 
              class="reserve-btn {{isBooked(item.id) ? 'reserve-btn-disabled' : ''}}" 
              bindtap="onReserve" 
              data-id="{{item.id}}" 
              disabled="{{isBooked(item.id)}}"
            >
              {{isBooked(item.id) ? '已报名' : '立即报名'}}
            </button>
            <button class="favorite-btn {{isFavorite(item.id) ? 'favorite-btn-active' : ''}}" catchtap="toggleFavorite" data-id="{{item.id}}">
              {{isFavorite(item.id) ? '已收藏' : '收藏'}}
            </button>
          </view>
        </view>
      </view>
    </block>
  </view>
  
  <view class="masonry-column">
    <block wx:for="{{rightColumnVenues}}" wx:key="id">
      <view class="venue-card" bindtap="showVenueDetail" data-id="{{item.id}}">
        <image src="{{item.cover}}" class="venue-img" mode="aspectFill" />
        <view class="venue-info">
          <text class="venue-title">{{item.name}}</text>
          <view class="venue-rating">
            <text class="star">★★★★★</text>
            <text class="score">{{item.rating}}</text>
          </view>
          <text class="venue-location">{{item.location}}</text>
          <view class="venue-tags">
            <text wx:for="{{item.sports}}" wx:key="index" class="tag">{{item}}</text>
          </view>
          <view class="venue-price">
            <text class="price">￥{{item.price}}</text>
            <text class="unit">/小时起</text>
          </view>
          <view class="button-group">
            <button 
              class="reserve-btn {{isBooked(item.id) ? 'reserve-btn-disabled' : ''}}" 
              bindtap="onReserve" 
              data-id="{{item.id}}" 
              disabled="{{isBooked(item.id)}}"
            >
              {{isBooked(item.id) ? '已报名' : '立即报名'}}
            </button>
            <button class="favorite-btn {{isFavorite(item.id) ? 'favorite-btn-active' : ''}}" catchtap="toggleFavorite" data-id="{{item.id}}">
              {{isFavorite(item.id) ? '已收藏' : '收藏'}}
            </button>
          </view>
        </view>
      </view>
    </block>
  </view>
</view>

<!-- 详情UI -->
<view class="detail-container" wx:if="{{currentView === 'detail'}}">
  <view class="back-btn" bindtap="backToList">←</view>
  <view style="height:20rpx"></view>
  <image class="detail-img" src="{{selectedVenue.cover}}" 
  mode="aspectFill" />
  <view class="detail-card">
    <view class="detail-badge">{{selectedVenue.category}}</view>
    <view class="detail-title">{{selectedVenue.name}}</view>
    <view class="detail-rating">
      <text class="star">★★★★★</text>
      <text class="score">{{selectedVenue.rating}}</text>
    </view>
    <view class="detail-location">地址：{{selectedVenue.location}}</view>
    <view class="detail-time">时间：{{selectedVenue.business_hours}}</view>
    <view class="detail-tags">
      <text wx:for="{{selectedVenue.sports}}" wx:key="index" class="tag">{{item}}</text>
    </view>
    <view class="detail-price">￥{{selectedVenue.price}} <text class="unit">/小时起</text></view>
    <view class="detail-desc">
      <text>活动介绍：</text>
      <text>{{selectedVenue.description}}</text>
    </view>
  </view>
  <view class="button-group">
    <button 
      class="detail-reserve-btn {{isBooked(selectedVenue.id) ? 'reserve-btn-disabled' : ''}}" 
      bindtap="onReserve" 
      data-id="{{selectedVenue.id}}" 
      disabled="{{isBooked(selectedVenue.id)}}"
    >
      {{isBooked(selectedVenue.id) ? '已报名' : '立即报名'}}
    </button>
    <button class="detail-favorite-btn" bindtap="toggleFavoriteDetail">
      {{favoriteVenues && selectedVenue.id && favoriteVenues.includes(selectedVenue.id) ? '已收藏' : '收藏'}}
    </button>
  </view>
  <!-- 删除按钮已移除，仅管理员可在活动管理中操作 -->
  <!-- 评论区 -->
  <view class="comment-section">
    <view class="comment-list">
      <block wx:for="{{comments}}" wx:key="id">
        <view class="comment-item">
          <image class="avatar" src="{{item.avatar_url}}" />
          <view class="comment-content">
            <text class="nickname">{{item.nickname}}</text>
            <text class="content">{{item.reply_to_user_id ? ('@' + item.reply_to_nickname + ' ') : ''}}{{item.content}}</text>
            <text class="time">{{item.created_at}}</text>
            <view class="comment-actions">
              <button size="mini" bindtap="onReplyComment" data-id="{{item.id}}" data-nickname="{{item.nickname}}" data-userid="{{item.user_id}}">回复</button>
              <button size="mini" wx:if="userInfo && userInfo.id === item.user_id" bindtap="onDeleteComment" data-id="{{item.id}}">删除</button>
            </view>
          </view>
          <!-- 子评论 -->
          <view class="replies" wx:if="item.replies && item.replies.length">
            <block wx:for="{{item.replies}}" wx:key="id">
              <view class="reply-item">
                <image class="avatar" src="{{item.avatar_url}}" />
                <view class="comment-content">
                  <text class="nickname">{{item.nickname}}</text>
                  <text class="content">{{item.reply_to_user_id ? ('@' + item.reply_to_nickname + ' ') : ''}}{{item.content}}</text>
                  <text class="time">{{item.created_at}}</text>
                  <view class="comment-actions">
                    <button size="mini" bindtap="onReplyComment" data-id="{{item.id}}" data-nickname="{{item.nickname}}" data-userid="{{item.user_id}}">回复</button>
                    <button size="mini" wx:if="userInfo && userInfo.id === item.user_id" bindtap="onDeleteComment" data-id="{{item.id}}">删除</button>
                  </view>
                </view>
              </view>
            </block>
          </view>
        </view>
      </block>
      <view wx:if="{{comments.length === 0}}" class="empty">暂无评论</view>
    </view>
    <view class="comment-input-bar">
      <input placeholder="{{replyPlaceholder}}" value="{{commentInput}}" bindinput="onCommentInput" />
      <button bindtap="submitComment">发送</button>
    </view>
  </view>
</view>

<!-- 报名弹窗 -->
<view class="booking-modal-mask" wx:if="{{showBookingModal}}" bindtap="closeBookingModal"></view>
<view class="booking-modal" wx:if="{{showBookingModal}}">
  <view class="booking-modal-title">填写报名信息</view>
  <view class="booking-modal-row">
    <text>日期：</text>
    <picker mode="date" value="{{bookingDate}}" bindchange="onBookingDateChange">
      <view class="picker-value">{{bookingDate || '请选择日期'}}</view>
    </picker>
  </view>
  <view class="booking-modal-row">
    <text>开始时间：</text>
    <picker mode="time" value="{{bookingStartTime}}" bindchange="onBookingStartTimeChange">
      <view class="picker-value">{{bookingStartTime || '请选择开始时间'}}</view>
    </picker>
  </view>
  <view class="booking-modal-row">
    <text>结束时间：</text>
    <picker mode="time" value="{{bookingEndTime}}" bindchange="onBookingEndTimeChange">
      <view class="picker-value">{{bookingEndTime || '请选择结束时间'}}</view>
    </picker>
  </view>
  <button class="booking-modal-btn" bindtap="submitBooking">提交报名</button>
  <button class="booking-modal-cancel" bindtap="closeBookingModal">取消</button>
</view>
